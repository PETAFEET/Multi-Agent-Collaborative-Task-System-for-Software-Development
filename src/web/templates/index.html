<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多智能体协作系统</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .agent-card {
        transition: transform 0.2s;
      }
      .agent-card:hover {
        transform: translateY(-2px);
      }
      .task-item {
        border-left: 4px solid #007bff;
        margin-bottom: 10px;
      }
      .status-badge {
        font-size: 0.8em;
      }
      .log-container {
        height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }
      .log-entry {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
      }
      .log-info {
        color: #0d6efd;
      }
      .log-success {
        color: #198754;
      }
      .log-warning {
        color: #fd7e14;
      }
      .log-error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-robot me-2"></i>多智能体协作系统
        </a>
        <div class="navbar-nav ms-auto">
          <span class="navbar-text">
            <i class="fas fa-circle text-success me-1"></i>系统运行中
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <div class="row">
        <!-- 左侧面板 -->
        <div class="col-md-4">
          <!-- 任务创建 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5><i class="fas fa-plus-circle me-2"></i>创建新任务</h5>
            </div>
            <div class="card-body">
              <form id="taskForm">
                <div class="mb-3">
                  <label for="taskType" class="form-label">任务类型</label>
                  <select class="form-select" id="taskType" required>
                    <option value="">选择任务类型</option>
                    <option value="travel_planning">旅行规划</option>
                    <option value="code_development">代码开发</option>
                    <option value="research_report">研究报告</option>
                    <option value="general">通用任务</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="taskDescription" class="form-label"
                    >任务描述</label
                  >
                  <textarea
                    class="form-control"
                    id="taskDescription"
                    rows="3"
                    placeholder="请详细描述您要完成的任务..."
                    required
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label for="taskPriority" class="form-label">优先级</label>
                  <select class="form-select" id="taskPriority">
                    <option value="normal">普通</option>
                    <option value="high">高</option>
                    <option value="urgent">紧急</option>
                    <option value="low">低</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-paper-plane me-2"></i>提交任务
                </button>
              </form>
            </div>
          </div>

          <!-- 智能体状态 -->
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-robot me-2"></i>智能体状态</h5>
            </div>
            <div class="card-body">
              <div id="agentsList">
                <div class="text-center text-muted">
                  <i class="fas fa-spinner fa-spin"></i> 加载中...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 中间面板 -->
        <div class="col-md-4">
          <!-- 任务列表 -->
          <div class="card mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5><i class="fas fa-tasks me-2"></i>任务列表</h5>
              <button
                class="btn btn-sm btn-outline-primary"
                onclick="refreshTasks()"
              >
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div class="card-body">
              <div id="tasksList">
                <div class="text-center text-muted">
                  <i class="fas fa-spinner fa-spin"></i> 加载中...
                </div>
              </div>
            </div>
          </div>

          <!-- 系统统计 -->
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-chart-bar me-2"></i>系统统计</h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-6">
                  <h4 class="text-primary" id="totalTasks">0</h4>
                  <small class="text-muted">总任务数</small>
                </div>
                <div class="col-6">
                  <h4 class="text-success" id="completedTasks">0</h4>
                  <small class="text-muted">已完成</small>
                </div>
              </div>
              <div class="row text-center mt-3">
                <div class="col-6">
                  <h4 class="text-warning" id="activeTasks">0</h4>
                  <small class="text-muted">进行中</small>
                </div>
                <div class="col-6">
                  <h4 class="text-danger" id="failedTasks">0</h4>
                  <small class="text-muted">失败</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧面板 -->
        <div class="col-md-4">
          <!-- 实时日志 -->
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5><i class="fas fa-terminal me-2"></i>实时日志</h5>
              <div>
                <button
                  class="btn btn-sm btn-outline-secondary"
                  onclick="clearLogs()"
                >
                  <i class="fas fa-trash"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-primary"
                  onclick="toggleAutoScroll()"
                >
                  <i class="fas fa-arrow-down" id="autoScrollIcon"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="log-container" id="logContainer">
                <div class="log-entry log-info">
                  <span class="text-muted">[系统]</span> 多智能体协作系统已启动
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 任务详情模态框 -->
    <div class="modal fade" id="taskModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">任务详情</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="taskDetails">
              <!-- 任务详情内容 -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 全局变量
      let ws = null;
      let autoScroll = true;
      let tasks = [];
      let agents = [];

      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        initializeWebSocket();
        loadAgents();
        loadTasks();

        // 设置定时刷新
        setInterval(loadAgents, 5000);
        setInterval(loadTasks, 3000);
      });

      // WebSocket连接
      function initializeWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          addLog("WebSocket连接已建立", "success");
        };

        ws.onmessage = function (event) {
          const message = JSON.parse(event.data);
          handleWebSocketMessage(message);
        };

        ws.onclose = function () {
          addLog("WebSocket连接已断开", "warning");
          // 尝试重连
          setTimeout(initializeWebSocket, 5000);
        };

        ws.onerror = function (error) {
          addLog("WebSocket错误: " + error, "error");
        };
      }

      // 处理WebSocket消息
      function handleWebSocketMessage(message) {
        switch (message.type) {
          case "task_created":
            addLog(`新任务已创建: ${message.task_id}`, "info");
            loadTasks();
            break;
          case "task_completed":
            addLog(`任务已完成: ${message.task_id}`, "success");
            loadTasks();
            break;
          case "task_failed":
            addLog(`任务失败: ${message.task_id}`, "error");
            loadTasks();
            break;
          case "agent_status_update":
            addLog(`智能体状态更新: ${message.agent_id}`, "info");
            loadAgents();
            break;
        }
      }

      // 任务表单提交
      document
        .getElementById("taskForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            type: document.getElementById("taskType").value,
            description: document.getElementById("taskDescription").value,
            priority: document.getElementById("taskPriority").value,
            requirements: {},
          };

          try {
            const response = await fetch("/api/tasks", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (response.ok) {
              addLog(`任务创建成功: ${result.task_id}`, "success");
              document.getElementById("taskForm").reset();
              loadTasks();
            } else {
              addLog(`任务创建失败: ${result.detail}`, "error");
            }
          } catch (error) {
            addLog(`任务创建错误: ${error.message}`, "error");
          }
        });

      // 加载智能体状态
      async function loadAgents() {
        try {
          const response = await fetch("/api/agents");
          const data = await response.json();

          agents = data;
          renderAgents();
        } catch (error) {
          addLog(`加载智能体状态失败: ${error.message}`, "error");
        }
      }

      // 渲染智能体状态
      function renderAgents() {
        const container = document.getElementById("agentsList");

        if (agents.length === 0) {
          container.innerHTML =
            '<div class="text-center text-muted">暂无智能体</div>';
          return;
        }

        container.innerHTML = agents
          .map(
            (agent) => `
                <div class="agent-card card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${agent.name}</h6>
                                <small class="text-muted">${
                                  agent.agent_id
                                }</small>
                            </div>
                            <span class="badge status-badge ${getStatusClass(
                              agent.status
                            )}">
                                ${agent.status}
                            </span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-tasks me-1"></i>${
                                  agent.task_count
                                } 个任务
                            </small>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // 加载任务列表
      async function loadTasks() {
        try {
          const response = await fetch("/api/tasks");
          const data = await response.json();

          tasks = data;
          renderTasks();
          updateStatistics();
        } catch (error) {
          addLog(`加载任务列表失败: ${error.message}`, "error");
        }
      }

      // 渲染任务列表
      function renderTasks() {
        const container = document.getElementById("tasksList");

        if (tasks.length === 0) {
          container.innerHTML =
            '<div class="text-center text-muted">暂无任务</div>';
          return;
        }

        container.innerHTML = tasks
          .map(
            (task) => `
                <div class="task-item card p-3" onclick="showTaskDetails('${
                  task.task_id
                }')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${task.description.substring(
                              0,
                              50
                            )}...</h6>
                            <small class="text-muted">${task.type}</small>
                        </div>
                        <span class="badge ${getStatusClass(task.status)}">
                            ${task.status}
                        </span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            ${new Date(task.created_at).toLocaleString()}
                        </small>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // 显示任务详情
      async function showTaskDetails(taskId) {
        try {
          const response = await fetch(`/api/tasks/${taskId}`);
          const task = await response.json();

          document.getElementById("taskDetails").innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <p><strong>任务ID:</strong> ${task.task_id}</p>
                            <p><strong>类型:</strong> ${task.type}</p>
                            <p><strong>状态:</strong> <span class="badge ${getStatusClass(
                              task.status
                            )}">${task.status}</span></p>
                            <p><strong>创建时间:</strong> ${new Date(
                              task.created_at
                            ).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>描述</h6>
                            <p>${task.description}</p>
                        </div>
                    </div>
                `;

          const modal = new bootstrap.Modal(
            document.getElementById("taskModal")
          );
          modal.show();
        } catch (error) {
          addLog(`获取任务详情失败: ${error.message}`, "error");
        }
      }

      // 更新统计信息
      function updateStatistics() {
        const total = tasks.length;
        const completed = tasks.filter((t) => t.status === "completed").length;
        const active = tasks.filter((t) => t.status === "executing").length;
        const failed = tasks.filter((t) => t.status === "failed").length;

        document.getElementById("totalTasks").textContent = total;
        document.getElementById("completedTasks").textContent = completed;
        document.getElementById("activeTasks").textContent = active;
        document.getElementById("failedTasks").textContent = failed;
      }

      // 获取状态样式类
      function getStatusClass(status) {
        const statusMap = {
          idle: "bg-secondary",
          thinking: "bg-info",
          executing: "bg-primary",
          waiting: "bg-warning",
          completed: "bg-success",
          failed: "bg-danger",
          error: "bg-danger",
          pending: "bg-secondary",
          planning: "bg-info",
          monitoring: "bg-warning",
        };
        return statusMap[status] || "bg-secondary";
      }

      // 添加日志
      function addLog(message, type = "info") {
        const container = document.getElementById("logContainer");
        const timestamp = new Date().toLocaleTimeString();

        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;

        container.appendChild(logEntry);

        if (autoScroll) {
          container.scrollTop = container.scrollHeight;
        }
      }

      // 清除日志
      function clearLogs() {
        document.getElementById("logContainer").innerHTML = "";
      }

      // 切换自动滚动
      function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const icon = document.getElementById("autoScrollIcon");
        icon.className = autoScroll ? "fas fa-arrow-down" : "fas fa-pause";
      }

      // 刷新任务
      function refreshTasks() {
        loadTasks();
        addLog("任务列表已刷新", "info");
      }
    </script>
  </body>
</html>
